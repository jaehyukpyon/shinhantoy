<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>order_detail > 주문상세페이지</title>

    <!-- <img src="none" style="cursor: pointer;" alt=""> -->

    <script src="https://code.jquery.com/jquery-3.6.3.min.js"
        integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>

    <script>
        $(document).ready(function () {
            const search = new URLSearchParams(location.search);
            const pk = search.get('pk');
            console.log('pk: ' + pk);
            $('#pk').text(pk);

            $.get('http://127.0.0.1:8000/api/order/' + pk + '/')
                .then((result) => {
                    $('#ORD_YMD').text(result.ord_ymd);
                    $('#ACCT_MANG_DBRN_CODE').text(result.acct_mang_dbrn_code);
                    $('#ORD_NO').text(result.ord_no);
                    $('#ACCT_NO').text(result.acct_no);
                    $('#CALLV_TYPE_CODE').text(result.callv_type_code);
                    $('#SELL_BUY_TP_CODE').text(result.sell_buy_tp_code);
                    $('#STBD_CODE').text(result.stbd_code);
                    $('#ORD_QTY').text(result.ord_qty);
                    $('#ORD_UV').text(result.ord_uv);
                    $('#MRGN_BASE_UV').text(result.mrgn_base_uv);
                });

            $('#writecomment').on('click', function () {
                submitComment();
            })
        });

        const loadComment = function () {
            $('#comment_area').empty();
            $.ajax({
                type: 'GET',
                url: 'http://127.0.0.1:8000/api/order/' + $('#pk').text() + '/comments/',            
                success: (result) => {
                    for (let i = 0; i < result.results.length; i++) {
                            const item = result.results[i];
                            console.log('-------------')
                            console.log(item)
                            $('#comment_area').append(`
                            <tr>                            
                                <td>${item.id}</td>                            
                                <td>${item.writer}</td>
                                <td>${item.created}</td>
                                <td>${item.content}</td>                            
                            </tr>
                            `);
                    }
                }, 
                error: (result) => {
                    console.error(result.error)
                }
            });            
        }

        const submitComment = function () {
            $.ajax({
                type: 'POST',
                url: 'http://127.0.0.1:8000/api/order/' + $('#pk').text() +'/comment/',
                data: {
                    order: $('#pk').text(),
                    content: $('#content').val().trim()
                },
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'JWT ' + $('#token').val());
                },
                success: (result) => {
                    alert('댓글이 등록되었습니다.')
                    loadComment();
                }, 
                error: (result) => {
                    console.error(result.error)
                }
            });
        }
    </script>

    <script>
        
    </script>
</head>

<body>

    <div class="container text-center">
        <br>
        <br>
        <h2 id="title">Order 정보 상세 조회<br>Order PK:<span id="pk"></span></h2>
    </div>

    <br>
    <hr>

    <div class="container">
        <div class="row">
            <div class="col">
                <table class="table">
                    <thead>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">ORD_YMD</th>
                            <td id="ORD_YMD">Mark</td>
                        </tr>
                        <tr>
                            <th scope="row">ACCT_MANG_DBRN_CODE</th>
                            <td id="ACCT_MANG_DBRN_CODE">Mark</td>
                        </tr>
                        <tr>
                            <th scope="row">ORD_NO</th>
                            <td id="ORD_NO">Jacob</td>
                        </tr>
                        <tr>
                            <th scope="row">ACCT_NO</th>
                            <td id="ACCT_NO">Larry</td>
                        </tr>
                        <tr>
                            <th scope="row">CALLV_TYPE_CODE</th>
                            <td id="CALLV_TYPE_CODE">Larry</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="col">
                <table class="table">
                    <thead>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">SELL_BUY_TP_CODE</th>
                            <td id="SELL_BUY_TP_CODE">Mark</td>
                        </tr>
                        <tr>
                            <th scope="row">STBD_CODE</th>
                            <td id="STBD_CODE">Jacob</td>
                        </tr>
                        <tr>
                            <th scope="row">ORD_QTY</th>
                            <td id="ORD_QTY">Larry</td>
                        </tr>
                        <tr>
                            <th scope="row">ORD_UV</th>
                            <td id="ORD_UV">Larry</td>
                        </tr>
                        <tr>
                            <th scope="row">MRGN_BASE_UV</th>
                            <td id="MRGN_BASE_UV">Larry</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <br>
    <hr>

    <div class="container">
        <textarea class="form-control" name="content" id="content" cols="30" rows="10">

        </textarea>

        <br>

        <input class="form-control" type="text" id="token" name="token">
        <label for="token">Token Please</label><br>
        <button type="button" class="btn btn-primary" id="writecomment">댓글등록</button>

        <hr>
        <h3>댓글 리스트</h3>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>댓글ID</th>
                    <th>작성자</th>
                    <th>작성일시</th>
                    <th>내용</th>
                </tr>
            </thead>
            <tbody id="comment_area">
            </tbody>
        </table>
    </div>

    <br>
    <br>
    <hr>

    <script>
        
            
        $(document).ready(function () {
            loadComment()
        })       
    </script>

</body>

</html>